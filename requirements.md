# 产假计算系统需求文档

## 1. 概述
产假计算系统是一个基于 React 的单页应用，围绕“产假周期、津贴计算、社保扣除、批量处理、基础数据管理与智能助手”六大模块展开，帮助企业人事高效完成产假相关业务。

## 2. 功能需求

### 2.1 主界面与导航（`src/App.js`）
- 提供顶部标题与描述文案。
- 支持 Tab 切换，默认显示 `产假津贴计算`。
- 当 URL 满足 `/management`、`?management=1` 或 `#management` 时展示 `基础数据管理` Tab。
- Tab 切换时渲染对应组件：`AllowanceCalculator`、`BatchProcessor`、`AIChatDemo`、`CityDataManager`。

### 2.2 产假津贴计算（`src/components/AllowanceCalculator.js`）
- **员工搜索**：支持按工号或姓名模糊搜索；从 `cityDataManager` 预加载员工列表并展示联想结果；选中员工后自动设置城市并填充基本工资。
- **城市规则联动**：加载津贴规则设置公司平均工资、社保上限、津贴发放方式（企业账户/个人账户）。
- **产假信息输入**：可配置难产、胎数、流产情况、怀孕时间段、医嘱天数等；自动计算产假结束日期（用户可覆盖）。
基础数据管理 - 📅产假规则 - 新增一个字段 流产类型， 并应用到产假计算中。 
如果，选择流产，则根据流产类型 确定 流产假天数。  

产假津贴计算 - 产假津贴计算 下拉框的值 为对应城市的 流产类型

怀孕时间段 所取的值动态更新， 从 db 📅产假规则 中， 取对应城市的 产假类型=流产假   ，所有 流产类型 的值 作为下来框的值。然后找到对应的 产假天数计算得到流产假天数， 流产假为单选，跟其他 产假互斥。如果 产假津贴计算 的字段 流产医嘱天数 有值， 则直接应用该值。给出计算过程。应用政策： 要给出说明， 如果是遗嘱，则说明是遗嘱天数。


产假顺延计算逻辑

节假日数据结构：
holidayUtils.js
 中的节假日对象包含 isLegalHoliday 字段（是否为法定假日）
产假规则：
cityDataUtils.js
 中的产假规则包含 isExtendable 字段（是否遇法定节假日顺延）
需求：当产假类型为"晚育假/生育假/奖励假"且 isExtendable=true 时，这部分假期应放在其他假期之后，并且遇到 isLegalHoliday=true 的日期需要顺延
我看到当前的结束日期计算逻辑在第271行：let end = addDays(start, totalMaternityDays - 1);，这是简单的日期加法。现在需要实现：

将产假规则分为两类：普通假期和可顺延假期（晚育假/生育假/奖励假且isExtendable=true）
先计算普通假期的结束日期
然后在普通假期结束日期之后，追加可顺延假期，遇到法定假日（isLegalHoliday=true）则顺延

- **工资信息**：录入单位申报平均工资、员工产前12个月月均工资、员工当前基本工资（可选）、政府发放金额覆盖、社保个人月缴覆盖；企业账户可填写已发工资；支持添加多个减扣项。
- **计算逻辑**：调用 `calculateMaternityAllowance()` 统一计算产假天数、津贴金、补差、个人社保、首末月应发、节假日工作日等。
- **结果展示**：显示产假周期、应用政策、津贴与补差明细、个人社保、实际到手、扣减后金额、首末月工作日计发工资、产假日历（`LeaveCalendar`）、产假条件、个人社保缴费月份。
- **操作**：提供计算与重置按钮；错误时弹窗提示。

### 2.3 批量处理（`src/components/BatchProcessor.js`）
- 批量处理跟2.2产假津贴计算，采用相同的计算逻辑。要共用代码。
- 支持下载 Excel 模板（`generateEmployeeTemplate()`）。
- 选择 Excel 文件后自动读取并预览前 5 条记录；校验格式与数值。
- 批量处理按钮调用 `processBatchData()` 完成津贴、产假周期、社保扣除计算；区分成功结果与错误清单。
- 结果区展示统计概览、详细结果表格、错误详情；可导出计算结果和错误报告（`exportResults()`）。
- 支持重置操作，清除所有状态。

### 2.4 基础数据管理（`src/components/CityDataManager.js`）
- 按 Tab 管理产假规则、津贴规则、员工信息、节假日。
- 支持按城市筛选、列表展示、添加、编辑、删除、保存到 IndexedDB。
- Excel 导入：使用 `parseExcelFile()` 解析并校验，存在错误时阻止导入并提示。
- Excel 导出：调用 `exportDataToExcel()`，或对节假日使用 `exportDataToExcelGeneric()`。
- 节假日管理：按年份查看、添加/移除日期、复制到下一年、导入导出模板、保存到 IndexedDB；支持 `warmUpHolidayPlan()`、`getAllHolidayYears()` 等能力。
- 节假日列表：行内“编辑/保存/取消”按钮，支持直接修改日期与类型并即时写回 IndexedDB。

### 2.5 智能助手 Mock（`src/components/AIChatDemo.js`）
- 模拟对话界面，默认提示用法。
- 支持文本输入、Enter 发送、语音输入（Web Speech API）、文件上传展示。
- 解析姓名、日期、难产类型并调用 `computeResult()` 输出固定示例结果。
- 提供示例快捷按钮和清空对话按钮。

### 2.6 其他工具模块
- `src/components/MaternityPeriodCalculator.js`：演示通过模拟 API 计算产假天数的独立界面。
- `src/components/DeductionCalculator.js`：单独计算社保与公积金扣除。
- `src/utils/cityDataUtils.js`：城市/员工数据管理、Excel 模板生成、校验器、IndexedDB 持久化接口。
- `src/utils/maternityCalculations.js`：产假天数计算、津贴计算、个人社保、首末月工资。
- `src/utils/batchCalculations.js`：批量处理调度与社保扣除计算。
- `src/utils/excelUtils.js`：Excel 模板生成、读取、导出。
- `src/utils/holidayUtils.js`：节假日计划读写、预热与工作日计算。
- `src/utils/indexedDb.js`：IndexedDB 简易封装。
- `src/api/maternityApi.js`：模拟后端 API。

## 3. 非功能需求
- 技术栈：React 18.2.0、`react-scripts`、`date-fns`、`xlsx`、`file-saver` 等。
- 数据持久化：IndexedDB。
- 前端构建与运行：`npm install`、`npm start`，默认运行在 `http://localhost:3000`。
- UI 要求：响应式布局、中文界面、错误提示友好、操作状态清晰。

## 4. 约束与假设
- 当前所有数据均存储在浏览器本地 IndexedDB，未接入真实后端。
- 智能助手为纯前端 Mock，不调用真实大模型。
- 批量导入仅支持 Excel（.xlsx/.xls）。
- 节假日数据需由用户导入或手动维护。

---

# 产假计算系统系统设计文档

## 1. 架构概览
```
React SPA
│
├── App (Tab 容器)
│   ├── AllowanceCalculator
│   ├── BatchProcessor
│   ├── AIChatDemo
│   └── CityDataManager (按 URL 控制显示)
│
├── utils/
│   ├── cityDataUtils (数据层 & 模板)
│   ├── maternityCalculations (核心计算)
│   ├── batchCalculations (批量编排)
│   ├── excelUtils (Excel 处理)
│   ├── holidayUtils (节假日)
│   ├── indexedDb (持久化封装)
│
└── api/
    └── maternityApi (模拟 API)
```

## 2. 组件设计

### 2.1 `App`
- 控制 Tab 切换与管理视图展示。
- 自动根据 URL 决定是否展示 `CityDataManager`。

### 2.2 `AllowanceCalculator`
- 管理大量表单状态与搜索状态。
- `useEffect` 预热城市/员工数据、节假日计划、自动计算结束日期。
- 调用 `calculateMaternityAllowance()` 获取计算结果并渲染。
- 嵌入 `LeaveCalendar` 可视化休假区间。

### 2.3 `BatchProcessor`
- 管理文件状态、预览、处理结果、错误列表。
- 使用 `excelUtils` 完成模板下载、文件解析、结果导出。
- 调用 `processBatchData()` 完成批量计算。

### 2.4 `CityDataManager`
- 维护多种表单与列表状态，支持新增/编辑/删除。
- 调用 `cityDataManager` 完成 IndexedDB 数据读写；导入/导出使用 `parseExcelFile()` 与 `exportDataToExcel()`。
- 节假日管理集成 `holidayUtils`，提供年份过滤、复制、手动维护。支持手动编辑， 增加编辑和保存按钮，点击编辑后在本行直接编辑，点击保存后，保存到数据库。
- 重构CityDataManager ， 📅产假规则 ，💰津贴规则，👥员工信息，🎌节假日 ，
拆分为不同的文件，并采用模拟MOCK API的方式调用。原来界面布局，保持不变。

### 2.5 `AIChatDemo`
- 维护消息列表、输入框、语音识别状态、上传文件列表。
- 通过 `parseInputs()` 抽取参数，`computeResult()` 生成固定示例输出。

### 2.6 其他组件
- `MaternityPeriodCalculator` 使用模拟 API 获取产假天数与周期。
- `DeductionCalculator` 计算社保与公积金扣除细项。

## 3. 数据与持久化设计
- `cityDataManager` 统一维护三类数据（产假规则、津贴规则、员工信息），提供 CRUD、批量导入导出。
- 数据持久化通过 `idbGet`/`idbSet` 保存到 IndexedDB。
- 节假日数据按年份存储，支持合并、预热、复制。
- 组件读取数据时需确保先调用 `cityDataManager.loadData()`。

## 4. 核心计算流程

### 4.1 产假津贴计算（`calculateMaternityAllowance`）
- 从 `cityDataManager` 获取津贴规则。
- 调用 `autoCalculateMaternityDays` 计算总天数与适用规则。
- 计算政府发放金额、公司应发工资、补差金额、个人社保等。
- 计算首月与末月工作日折算工资，返回详细结构体供 UI 展示。
- 支持计算过程展示，产假天数应用了哪些政策，津贴计算了哪些金额，政府发放金额，公司应发金额，个人社保扣除了哪些金额，补差金额

### 4.2 批量处理（`processBatchData`）
- 使用 `validateEmployeeData()` 检验每条数据。
- 调用 `calculateMaternityAllowance()` + 个人社保扣除计算，生成汇总信息。
- 收集错误明细与成功结果，供 UI 展示并导出。

### 4.3 节假日与工作日
- `holidayUtils` 提供节假日计划、调休工作日集合及工作日统计函数。
- 津贴计算首末月工资时使用工作日统计函数。
🎌节假日
分组列增加编辑按钮，支持编辑，点击编辑后在分组所在行编辑，支持编辑  节日 和 日期 字段。 日期 字段支持选择 开始日期和结束日期， 选择保存后，分组下面的所有列均同步更新，比如选择10月1日 - 10月7日，下面则更新为1月1-7日的7条数据，数据要立即更新到数据库。

我理解了，需要为分组行添加编辑功能，支持批量修改节日名称和日期范围
## 5. Excel 支撑能力
- 模板生成：`generateMaternityRulesTemplate()`、`generateAllowanceRulesTemplate()`、`generateEmployeeTemplate()`。
- 解析：`parseExcelFile()` 按类型转换字段并校验。
- 导出：`exportDataToExcel()` 与 `exportResults()` 输出计算结果、错误信息、说明工作表。

## 6. 模拟 API
- `calculateMaternityDaysApi()`：面向前端封装的产假天数计算接口。
- `listCitiesApi()`、`listEmployeesByCityApi()`：提供城市与员工数据列表，演示前后端拆分。

## 7. 错误处理与验证
- Excel 导入、表单提交、城市选择等场景提供详细错误提示或 `alert`。
- `CityDataManager` 导入失败时显示错误行号与示例。
- `calculateMaternityAllowance()` 对缺少城市规则直接抛出异常，由 UI 捕获提醒用户。

## 8. 扩展性与未来工作
- `cityDataManager` 与模拟 API 已为接入真实后端做好接口封装。
- 可扩展更多城市规则字段或员工属性，无需大幅修改组件逻辑。
- 智能助手可替换为真实大模型 API。
- 可根据业务需要增加权限控制、审计、导出模板多语言等能力。

绍兴二孩 三孩 规则
在 产假津贴计算页 -  产假情况 里面   -  ： 如果城市是绍兴，产假情况新增一个选择框， 生育二孩、三孩， 放在 胎数 后面。产假天数计算逻辑：如果选中，则去 产假规则  ，城市=绍兴，找到 产假类型=晚育假/生育假/奖励假-二孩、三孩 的对应天数，进行累加。此假跟 晚育假/生育假/奖励假 互斥。
## 9. 产假规则表
| 城市 | 产假规则 |
|------|----------|
| **Shanghai** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假60天（日历日，遇法定节假日顺延）<br>流产假：妊娠未满4个月15天，妊娠满4个月42天（日历日） |
| **Shenzhen** | 法定产假98天（日历日） + 难产假30天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假80天（日历日）<br>流产假：怀孕未满4个月15-30天，怀孕4-7个月42天，怀孕满7个月75天（日历日） |
| **Guangzhou** | 法定产假98天（日历日） + 难产假30天/其他15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假80天（日历日）<br>流产假：怀孕4个月以下15-30天，怀孕4-7个月42天，怀孕满7个月75天（日历日） |
| **Tianjin** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假60天（日历日）<br>流产假：妊娠未满4个月15天，妊娠满4个月42天（日历日） |
| **Shaoxing** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假一孩60天/二孩三孩90天（日历日）<br>流产假：怀孕不满4个月15天，怀孕满4个月42天（日历日） |
| **Xiamen** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假60天（日历日）<br>流产假：怀孕3个月内15天，怀孕3个月以上42天，怀孕满7个月98天（日历日） |
| **Chengdu** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假60天（日历日）<br>流产假：怀孕未满4个月15天，怀孕满4个月42天（日历日） |
| **Suzhou** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假60天（日历日，遇法定节假日顺延）<br>流产假：怀孕不满2个月≥20天，怀孕2-3个月≥30天，怀孕3-7个月≥42天，怀孕满7个月≥98天（日历日） |
| **Qingdao** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假60天（日历日）<br>流产假：怀孕未满4个月15天，怀孕满4个月42天（日历日） |
| **Beijing** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假60天（日历日）<br>流产假：怀孕未满4个月15-30天，怀孕4-7个月42天，怀孕7个月以上按正常产假（日历日） |
| **Chongqing** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假80天（日历日）<br>流产假：4个月以下15天，4个月以上42天，宫外孕42天（日历日） |
| **Zhuhai/Foshan** | 法定产假98天（日历日） + 难产假30天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假80天（日历日）<br>流产假：怀孕4个月以下15-30天，怀孕4-7个月42天，怀孕满7个月75天（日历日） |
| **Wuhan** | 法定产假98天（日历日） + 难产假15天（日历日） + 多胞胎每胎加15天（日历日） + 奖励假60天（日历日）<br>流产假：妊娠不满12周30天，妊娠12-28周45天，妊娠满28周98天（日历日） |

## 10. 补差规则表

| 城市 | 补差计算规则 |
|------|----------|
| 北京 | 汇至账户：企业；计算基数：职工所在用人单位月缴费平均工资/30*产假天数；补差规定：1、生育津贴高于本人工资标准的，用人单位不得克扣；2、生育津贴低于本人工资标准的，差额部分由企业补足 |
| 佛山 | 汇至账户：企业；计算基数：按照企业上年度职工月平均工资/30*产假天数；补差规定：生育津贴高于职工原工资标准的，企业应当将生育津贴余额支付给职工；生育津贴低于职工原工资标准的，差额部分由企业补足 |
| 广州 | 汇至账户：企业；计算基数：用人单位上年度职工月平均工资除以30再乘以规定的假期天数计发；补差规定：1、生育津贴高于职工原工资标准的，企业应当将生育津贴余额支付给职工；2、生育津贴低于职工原工资标准的，差额部分由企业补足 |
| 深圳 | 汇至账户：企业；计算基数：用人单位上年度职工月平均工资除以30再乘以规定的假期天数计发；补差规定：1、生育津贴高于职工原工资标准的，企业应当将生育津贴余额支付给职工；2、生育津贴低于职工原工资标准的，差额部分由企业补足 |
| 珠海 | 汇至账户：企业；计算基数：用人单位上年度职工月平均工资除以30再乘以规定的假期天数计发；补差规定：社保经办机构拨付的生育津贴高于职工原工资标准的，单位应当将生育津贴差额支付给职工 |
| 武汉 | 汇至账户：企业；计算基数：用人单位实际申报缴费的上年度职工月平均工资除以30日计算；补差规定：1、生育津贴高于本人工资的，就高全额计发生育津贴；2、生育津贴低于本人工资的，企业补足 |
| 苏州（园区） | 汇至账户：企业（生育津贴划入至企业账户 为产期保健补贴、一次性营业补助发放至参保人员的社会保障市民卡的银联账户）；计算基数：用人单位上年度职工月平均工资计发（用人单位上年度12月份在职职工的年度月平均工资总额除以对应人数确定）；补差规定：1、工资高于津贴，需要补差；工资低于津贴，按津贴发放 |
| 成都 | 汇至账户：企业；计算基数：用人单位上年度职工月平均工资乘以12（月份）除以365（天数），再乘以产假具体天数计发；补差规定：无 |
| 重庆 | 汇至账户：企业；计算基数：生育津贴=单位上年度月平均工资÷30天×产假天数；补差规定：无 |
| 天津 | 汇至账户：个人（按月发放至本人社会保障卡账户）；计算基数：按女职工所在用人单位上年度职工月平均工资（即女职工生育或终止妊娠当月，其所在用人单位职工人均缴纳生育保险费的基数）除以30.4计算；补差规定：1、工资高于津贴，需要补差；工资低于津贴，按津贴发放 |
| 绍兴 | 汇至账户：个人；计算基数：职工生育或实施计划生育手术时所在用人单位上年度职工月平均缴费工资÷30×规定的假期天数；补差规定：补差：低于女职工产假前工资标准的，有条件的用人单位可以对差额部分予以补足 |
| 厦门 | 汇至账户：个人；计算基数：用人单位上年度月平均缴费工资/30*产假天数；补差规定：协商 |
| 上海 | 汇至账户：个人；计算基数：按其所在单位上年度职工月平均工资作为计发标准；补差规定：1、女职工生育或流产前12个月都在同一家单位缴纳社保，且员工生产前12个月的月平均工资高于单位申报的上一年度单位月平均工资，那单位就需要补差；2、女职工生育或流产当月所在用人单位的上年度职工月平均工资高于本市上年度社平工资300%以上的，高出部分由用人单位补差 |
| 青岛 | 汇至账户：个人；计算基数：按照职工所在用人单位上年度职工月平均工资除以30；补差规定：1、若单位平均工资高于三倍社平，需要补差；2、职工按照《山东省人口与计划生育条例》规定增加的产假工资由用人单位照发 |

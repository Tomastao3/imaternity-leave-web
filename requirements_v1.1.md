# 产假计算系统需求文档 v1.1

## 文档说明
本文档为产假计算系统的完整需求规格说明，可用于系统重构或重新开发。文档涵盖产假计算、津贴计算、基础数据管理三大核心模块。

---
---

## 🎯 目标目录结构

```
src/
├── features/
│   └── allowance-calculator/
│       ├── index.js                              # 导出入口
│       │
│       ├── components/                           # UI 组件层
│       │   ├── AllowanceCalculatorContainer.jsx  # 主容器（协调器）
│       │   │
│       │   ├── forms/                            # 表单组件
│       │   │   ├── EmployeeSearchForm.jsx        # 员工搜索表单
│       │   │   ├── CitySelector.jsx              # 城市选择器
│       │   │   ├── MaternityInfoForm.jsx         # 产假信息表单
│       │   │   ├── AllowanceInfoForm.jsx         # 津贴信息表单
│       │   │   ├── DeductionForm.jsx             # 减扣项表单
│       │   │   ├── RefundRulesForm.jsx           # 返还规则表单
│       │   │   └── SalaryAdjustmentForm.jsx      # 工资调整表单
│       │   │
│       │   ├── results/                          # 结果展示组件
│       │   │   ├── CalculationResult.jsx         # 计算结果主组件
│       │   │   ├── AllowanceBreakdown.jsx        # 津贴明细
│       │   │   ├── SupplementDetails.jsx         # 补差明细
│       │   │   ├── DeductionSummary.jsx          # 减扣汇总
│       │   │   └── RefundSummary.jsx             # 返还汇总
│       │   │
│       │   ├── calendar/                         # 日历组件
│       │   │   ├── MaternityLeaveCalendar.jsx    # 产假日历
│       │   │   └── RefundLeaveCalendar.jsx       # 返还日历
│       │   │
│       │   ├── actions/                          # 操作按钮组件
│       │   │   ├── CalculateButton.jsx           # 计算按钮
│       │   │   ├── ExportButtons.jsx             # 导出按钮组
│       │   │   └── ResetButton.jsx               # 重置按钮
│       │   │
│       │   └── shared/                           # 共享 UI 组件
│       │       ├── FormField.jsx                 # 表单字段
│       │       ├── ErrorMessage.jsx              # 错误提示
│       │       └── LoadingSpinner.jsx            # 加载动画
│       │
│       ├── hooks/                                # 自定义 Hooks
│       │   ├── useAllowanceCalculator.js         # 主业务逻辑 Hook
│       │   ├── useEmployeeSearch.js              # 员工搜索 Hook
│       │   ├── useCityData.js                    # 城市数据 Hook
│       │   ├── useMaternityInfo.js               # 产假信息 Hook
│       │   ├── useAllowanceInfo.js               # 津贴信息 Hook
│       │   ├── useDeductions.js                  # 减扣项 Hook
│       │   ├── useRefundRules.js                 # 返还规则 Hook
│       │   ├── useSalaryAdjustment.js            # 工资调整 Hook
│       │   └── useCalculationResult.js           # 计算结果 Hook
│       │
│       ├── services/                             # 业务逻辑服务层
│       │   ├── AllowanceCalculatorService.js     # 主计算服务
│       │   ├── EmployeeService.js                # 员工服务
│       │   ├── MaternityCalculationService.js    # 产假计算服务
│       │   ├── AllowanceCalculationService.js    # 津贴计算服务
│       │   ├── DeductionService.js               # 减扣计算服务
│       │   ├── RefundService.js                  # 返还计算服务
│       │   └── ExportService.js                  # 导出服务
│       │
│       ├── utils/                                # 工具函数
│       │   ├── validators.js                     # 表单验证
│       │   ├── formatters.js                     # 数据格式化
│       │   ├── calculators.js                    # 计算辅助函数
│       │   └── transformers.js                   # 数据转换
│       │
│       ├── constants/                            # 常量定义
│       │   ├── formDefaults.js                   # 表单默认值
│       │   ├── validationRules.js                # 验证规则
│       │   └── uiConstants.js                    # UI 常量
│       │
│       ├── types/                                # 类型定义
│       │   ├── allowanceTypes.js                 # 津贴相关类型
│       │   ├── employeeTypes.js                  # 员工相关类型
│       │   └── calculationTypes.js               # 计算相关类型
│       │
│       └── styles/                               # 样式文件
│           ├── AllowanceCalculator.module.css    # 主样式
│           └── themes.js                         # 主题配置
│
└── components/                                   # 保留原位置（向后兼容）
    └── AllowanceCalculator.js                    # 重新导出新组件
```

---

## 1. 产假计算模块

### 1.1 产假天数自动计算

#### 1.1.1 功能描述
根据城市规则、员工产假情况（是否难产、胎数、流产情况等）自动计算产假天数，并生成产假周期（开始日期、结束日期）。

#### 1.1.2 输入参数
- **城市**（必填）：员工所在城市，用于匹配产假规则
- **产假开始日期**（必填）：格式 YYYY-MM-DD
- **是否难产**（可选）：布尔值，默认 false
- **胎数**（可选）：整数，默认 1
- **是否流产**（可选）：布尔值，默认 false
- **怀孕时间段**（流产时必填）：
  - 4个月以下
  - 4个月以上7个月以下
  - 7个月以上
- **流产医嘱天数**（可选）：整数，如填写则优先使用医嘱天数
- **是否补充难产**（广州特有）：布尔值，用于区分剖腹产、会阴Ⅲ度破裂
- **是否生育二孩、三孩**（绍兴特有）：布尔值，与普通奖励假互斥

#### 1.1.3 计算规则

##### 基础规则
产假天数由以下部分累加：
1. **法定产假**：固定天数（通常98天）
2. **难产假**：如勾选"是否难产"，增加对应天数
3. **多胞胎假**：(胎数 - 1) × 每胎增加天数
4. **晚育假/生育假/奖励假**：根据城市规则增加天数
5. **流产假**：与其他产假互斥，单独计算

##### 特殊规则

**1. 流产假计算（与其他产假互斥）**
- 如勾选"是否流产"，则仅计算流产假，不叠加其他产假类型
- 流产假天数优先级：
  1. 医嘱天数（如填写）
  2. 根据"怀孕时间段"从产假规则表查询对应天数
  3. 默认值（如无规则）：4个月以下15天，4-7个月42天，7个月以上75天

**2. 广州难产假特殊处理**
- 广州有两种难产假：
  - 普通难产（吸引产、钳产、臀位牵引产）：15天
  - 补充难产（剖腹产、会阴Ⅲ度破裂）：30天
- 通过"是否难产"和"是否补充难产"两个字段区分

**3. 绍兴二孩三孩特殊规则**
- 绍兴市奖励假分为：
  - 一孩：60天（晚育假/生育假/奖励假）
  - 二孩、三孩：90天（晚育假/生育假/奖励假-二孩、三孩）
- 两者互斥，通过"是否生育二孩、三孩"字段选择
- 如勾选"是否生育二孩、三孩"，则查找产假类型为"晚育假/生育假/奖励假-二孩、三孩"的规则

**4. 法定节假日顺延规则**
- 部分城市的"晚育假/生育假/奖励假"支持遇法定节假日顺延
- 产假规则表中字段`isExtendable`标记是否支持顺延
- 顺延计算逻辑：
  1. 先计算非顺延假期的结束日期
  2. 从非顺延假期结束日的下一天开始，追加可顺延假期天数
  3. 遇到法定假日（`isLegalHoliday=true`）则顺延，不计入产假天数
  4. 直到累计够可顺延假期的天数为止

#### 1.1.4 输出结果
```javascript
{
  totalMaternityDays: 158,           // 总产假天数
  appliedRules: [                    // 应用的规则明细
    { type: "法定产假", days: 98 },
    { type: "晚育假/生育假/奖励假", days: 60, isExtendable: true, extendedDays: 3 }
  ],
  calculatedPeriod: {                // 产假周期
    startDate: "2025年03月01日",
    endDate: "2025年08月05日",
    actualDays: 158,
    workingDays: 113,                // 工作日预估（周一至周五）
    period: "2025年03月01日 - 2025年08月05日"
  }
}
```

#### 1.1.5 各城市产假规则表

| 城市 | 法定产假 | 难产假 | 多胞胎 | 奖励假 | 流产假 | 特殊说明 |
|------|---------|--------|--------|--------|--------|----------|
| 上海 | 98天 | 15天 | 每胎+15天 | 60天（顺延） | 4月以下15天，4月以上42天 | - |
| 深圳 | 98天 | 30天 | 每胎+15天 | 80天 | 4月以下15-30天，4-7月42天，7月以上75天 | - |
| 广州 | 98天 | 15天/30天 | 每胎+15天 | 80天 | 4月以下15-30天，4-7月42天，7月以上75天 | 难产分两种 |
| 天津 | 98天 | 15天 | 每胎+15天 | 60天 | 4月以下15天，4月以上42天 | - |
| 绍兴 | 98天 | 15天 | 每胎+15天 | 一孩60天/二孩三孩90天 | 4月以下15天，4月以上42天 | 二孩三孩特殊规则 |
| 厦门 | 98天 | 15天 | 每胎+15天 | 60天 | 3月内15天，3月以上42天，7月以上98天 | - |
| 成都 | 98天 | 15天 | 每胎+15天 | 60天 | 4月以下15天，4月以上42天 | - |
| 苏州 | 98天 | 15天 | 每胎+15天 | 60天（顺延） | 2月以下≥20天，2-3月≥30天，3-7月≥42天，7月以上≥98天 | - |
| 青岛 | 98天 | 15天 | 每胎+15天 | 60天 | 4月以下15天，4月以上42天 | - |
| 北京 | 98天 | 15天 | 每胎+15天 | 60天 | 4月以下15-30天，4-7月42天，7月以上按正常产假 | - |
| 重庆 | 98天 | 15天 | 每胎+15天 | 80天 | 4月以下15天，4月以上42天，宫外孕42天 | - |
| 珠海/佛山 | 98天 | 30天 | 每胎+15天 | 80天 | 4月以下15-30天，4-7月42天，7月以上75天 | - |
| 武汉 | 98天 | 15天 | 每胎+15天 | 60天 | 12周以下30天，12-28周45天，28周以上98天 | - |

---

## 2. 津贴计算模块

### 2.1 产假津贴计算

#### 2.1.1 功能描述
根据城市津贴规则、员工工资信息、产假天数，计算政府发放的生育津贴、员工应领取金额、公司需补差金额、个人社保缴费等。

#### 2.1.2 输入参数

**基础参数**
- **城市**（必填）：用于匹配津贴规则
- **员工产前12个月平均工资**（必填）：员工基本工资，单位：元/月
- **产假开始日期**（必填）：格式 YYYY-MM-DD
- **产假结束日期**（可选）：如不填写则自动计算
- **产假情况**（同产假计算模块）：
  - 是否难产
  - 胎数
  - 是否流产
  - 怀孕时间段
  - 流产医嘱天数
  - 是否补充难产（广州）
  - 是否生育二孩、三孩（绍兴）

**工资与津贴参数**
- **单位上年度月平均工资**（必填）：从津贴规则自动获取，可手动覆盖
- **社保3倍上限**（必填）：从津贴规则自动计算（社平工资×3），可手动覆盖
- **津贴发放方式**（必填）：企业账户 / 个人账户，从津贴规则自动获取
- **津贴计算基数**（自动）：平均工资 / 平均缴费工资，从津贴规则获取

**可选覆盖参数**
- **政府发放金额覆盖**：手动指定政府发放金额
- **社保公积金个人月缴费覆盖**：手动指定个人社保月缴费金额
- **员工基本工资（当前）**：如与产前12个月平均工资不同，可单独填写

**高级参数（用于精确计算）**
- **产假期间工资调整**：
  - 调整前工资
  - 调整后工资
  - 调整月份（格式：YYYY-MM）
- **产假期间社保调整**：
  - 调整前月缴费金额
  - 调整后月缴费金额
  - 调整月份（格式：YYYY-MM）
- **已发产假期间工资**（企业账户）：企业已发放的工资金额
- **减扣项**（动态列表）：
  - 金额
  - 说明

#### 2.1.3 计算规则

##### 核心计算公式

**1. 政府发放金额（生育津贴）**
```
津贴计算基数 = min(社保3倍上限, 单位上年度月平均工资)
日津贴 = 津贴计算基数 / 30
政府发放金额 = 日津贴 × 产假天数
```

**2. 员工应领取金额**
```
计算基数 = max(单位上年度月平均工资, 员工产前12个月平均工资)

// 成都特殊公式
员工应领取金额 = 计算基数 × 12 / 365 × 产假天数

// 天津特殊公式（除数为30.4）
员工应领取金额 = 计算基数 / 30.4 × 产假天数

// 其他城市通用公式
员工应领取金额 = 计算基数 / 30 × 产假天数
```

**3. 公司补差金额**
```
公司补差金额 = max(0, 员工应领取金额 - 政府发放金额)
```

**4. 个人社保缴费（仅整月产假计算）**
```
个人社保费率 = 养老8% + 医疗2% + 失业0.5% + 公积金12% = 22.5%
月缴费金额 = 员工产前12个月平均工资 × 22.5%
个人社保缴费 = 月缴费金额 × 整月产假月数
```

整月产假判断规则：
- 首月：如产假从1号开始，或首月无实际出勤天数，计入整月
- 中间月：完全覆盖的月份计入整月
- 末月：如产假到月末最后一天，或末月无实际出勤天数，计入整月

**5. 首月/末月工作日计发工资**
```
首月应发工资 = 员工基本工资 / 首月工作日天数 × 首月实际出勤天数
末月应发工资 = 员工基本工资 / 末月工作日天数 × 末月实际出勤天数
```

工作日计算规则：
- 默认周一至周五为工作日
- 排除法定节假日（`isLegalHoliday=true`）
- 包含调休上班日（`isMakeupWorkday=true`）

**6. 调整后的补差金额**
```
调整后补差 = 公司补差金额 - 减扣项总额
```

##### 特殊规则

**1. 津贴发放方式影响**
- **企业账户**：
  - 政府将津贴发放到企业账户
  - 企业需向员工发放工资
  - 需计算公司补差金额
  - 可填写"已发产假期间工资"
  
- **个人账户**：
  - 政府将津贴直接发放到员工个人账户
  - 员工需自行缴纳社保个人部分
  - 需计算个人社保缴费
  - 实际补差 = 公司补差 - 个人社保缴费

**2. 津贴计算基数类型**
- **平均工资**：使用单位上年度月平均工资
- **平均缴费工资**：使用单位上年度月平均缴费工资（如配置）

**3. 工资调整处理**
如产假期间发生工资调整：
- 调整月份之前的月份使用调整前工资
- 调整月份及之后的月份使用调整后工资
- 分别计算首月、末月应发工资

**4. 社保调整处理**
如产假期间发生社保基数调整：
- 调整月份之前的月份使用调整前月缴费金额
- 调整月份及之后的月份使用调整后月缴费金额
- 个人社保缴费 = 调整前月数×调整前金额 + 调整后月数×调整后金额

#### 2.1.4 输出结果
```javascript
{
  // 基础信息
  city: "上海",
  totalMaternityDays: 158,
  appliedRules: [...],              // 产假规则明细
  maternityPolicy: "上海市女职工劳动保护实施办法",
  allowancePolicy: "按上海市规定发放",
  calculatedPeriod: {...},          // 产假周期
  
  // 津贴计算结果
  maternityAllowanceBase: 34500.00, // 津贴计算基数
  dailyAllowance: 1150.00,          // 日津贴
  governmentPaidAmount: 181700.00,  // 政府发放金额
  
  // 员工应领取
  employeeReceivable: 181700.00,    // 员工应领取金额
  
  // 公司补差
  companySupplement: 0.00,          // 公司补差金额
  
  // 个人社保
  personalSocialSecurity: 0.00,     // 个人社保缴费
  personalSSMonths: ["2025-03", "2025-04", ...], // 缴费月份
  personalSSMonthsCount: 5,         // 缴费月数
  personalSSBreakdown: {...},       // 缴费明细
  
  // 首末月工资
  startMonthProratedWage: 8000.00,  // 首月应发工资
  endMonthProratedWage: 6000.00,    // 末月应发工资
  startMonthMeta: {...},            // 首月计算元数据
  endMonthMeta: {...},              // 末月计算元数据
  
  // 其他
  actualCompensation: 0.00,         // 实际补差（扣除个人社保后）
  totalReceived: 181700.00,         // 员工实际可得
  isSupplementNeeded: false,        // 是否需要补差
  paymentMethod: "企业账户",        // 津贴发放方式
  
  // 调试信息
  debugInfo: {...}
}
```

#### 2.1.5 各城市津贴规则表

| 城市 | 汇至账户 | 计算基数 | 补差规定 |
|------|---------|---------|----------|
| 北京 | 企业 | 职工所在用人单位月缴费平均工资/30×产假天数 | 1. 津贴高于工资标准的，企业不得克扣<br>2. 津贴低于工资标准的，差额部分由企业补足 |
| 上海 | 个人 | 单位上年度职工月平均工资/30×产假天数 | 1. 员工产前12个月月平均工资高于单位申报的上年度单位月平均工资，单位需补差<br>2. 单位上年度职工月平均工资高于社平工资300%以上的，高出部分由企业补差 |
| 深圳 | 企业 | 用人单位上年度职工月平均工资/30×产假天数 | 1. 津贴高于职工原工资标准的，企业应将津贴余额支付给职工<br>2. 津贴低于职工原工资标准的，差额部分由企业补足 |
| 广州 | 企业 | 用人单位上年度职工月平均工资/30×产假天数 | 1. 津贴高于职工原工资标准的，企业应将津贴余额支付给职工<br>2. 津贴低于职工原工资标准的，差额部分由企业补足 |
| 天津 | 个人 | 女职工所在用人单位上年度职工月平均工资/30.4×产假天数 | 工资高于津贴，需要补差；工资低于津贴，按津贴发放 |
| 绍兴 | 个人 | 职工所在用人单位上年度职工月平均缴费工资/30×产假天数 | 低于女职工产假前工资标准的，有条件的用人单位可以对差额部分予以补足 |
| 厦门 | 个人 | 用人单位上年度月平均缴费工资/30×产假天数 | 协商 |
| 成都 | 企业 | 用人单位上年度职工月平均工资×12/365×产假天数 | 无 |
| 苏州（园区） | 企业 | 用人单位上年度职工月平均工资/30×产假天数 | 工资高于津贴，需要补差；工资低于津贴，按津贴发放 |
| 青岛 | 个人 | 职工所在用人单位上年度职工月平均工资/30×产假天数 | 1. 若单位平均工资高于三倍社平，需要补差<br>2. 按《山东省人口与计划生育条例》规定增加的产假工资由用人单位照发 |
| 重庆 | 企业 | 单位上年度月平均工资/30×产假天数 | 无 |
| 佛山 | 企业 | 企业上年度职工月平均工资/30×产假天数 | 津贴高于职工原工资标准的，企业应将津贴余额支付给职工；津贴低于职工原工资标准的，差额部分由企业补足 |
| 珠海 | 企业 | 用人单位上年度职工月平均工资/30×产假天数 | 社保经办机构拨付的津贴高于职工原工资标准的，单位应将津贴差额支付给职工 |
| 武汉 | 企业 | 用人单位实际申报缴费的上年度职工月平均工资/30×产假天数 | 1. 津贴高于本人工资的，就高全额计发津贴<br>2. 津贴低于本人工资的，企业补足 |

### 2.2 批量计算

#### 2.2.1 功能描述
支持Excel批量导入员工数据，自动计算产假天数、津贴补差、社保扣除，并导出详细结果报告。

#### 2.2.2 Excel模板格式

**必填字段**
- 员工姓名
- 员工编号
- 城市
- 产假开始日期（格式：YYYY-MM-DD）
- 员工产前12个月的月均工资（元）
- 津贴发放方式（企业账户/个人账户）

**可选字段**
- 部门
- 职位
- 是否难产（是/否）
- 胎数（默认1）
- 怀孕时间段（默认"7个月以上"）
- 备注

#### 2.2.3 批量处理流程
1. 下载Excel模板
2. 填写员工数据
3. 选择Excel文件上传
4. 系统自动预览前5条数据
5. 点击"开始批量处理"
6. 系统逐条计算：
   - 产假天数计算
   - 津贴补差计算
   - 社保扣除计算
7. 显示处理结果统计
8. 导出结果Excel文件

#### 2.2.4 导出结果格式

**计算结果工作表**
- 员工姓名、员工编号、部门、职位、城市
- 产假开始日期、产假结束日期、享受产假天数
- 是否难产、胎数、妊娠时间段
- 社保缴费基数、日津贴标准
- 政府发放金额、需补差金额
- 月度社保扣除明细、实际社保扣除明细

**错误信息工作表**
- 行号、员工姓名、员工编号、错误信息

**处理汇总工作表**
- 处理总数、成功处理、失败数量、成功率
- 津贴总额、补差总额、扣除总额
- 处理时间

---

## 3. 基础数据管理模块

### 3.1 产假规则管理

#### 3.1.1 数据结构
```javascript
{
  id: 1,                                    // 自增ID
  city: "上海",                             // 城市名称
  leaveType: "法定产假",                    // 产假类型
  miscarriageType: "",                      // 流产类型（仅流产假需要）
  days: 98,                                 // 产假天数
  isExtendable: false,                      // 是否遇法定节假日顺延
  notes: "",                                // 备注
  createdAt: "2025-01-01T00:00:00Z",       // 创建时间
  updatedAt: "2025-01-01T00:00:00Z"        // 更新时间
}
```

#### 3.1.2 产假类型枚举
- **法定产假**：基础产假天数
- **难产假**：难产情况增加的天数
- **难产假（剖腹产、会阴Ⅲ度破裂）**：广州特有，补充难产假
- **多胞胎**：每增加一胎增加的天数
- **晚育假/生育假/奖励假**：奖励假天数
- **晚育假/生育假/奖励假-二孩、三孩**：绍兴特有，二孩三孩奖励假
- **流产假**：流产情况的假期天数

#### 3.1.3 流产类型枚举
- 4个月以下
- 4个月以上7个月以下
- 7个月以上
- 未满4个月
- 满4个月
- 怀孕不满2个月
- 怀孕2-3个月
- 怀孕3-7个月
- 怀孕满7个月
- 妊娠不满12周
- 妊娠12-28周
- 妊娠满28周
- 宫外孕
- （各城市可能有不同表述）

#### 3.1.4 功能列表
- ✅ 查看产假规则列表
- ✅ 按城市筛选
- ✅ 添加新规则
- ✅ 编辑规则（行内编辑）
- ✅ 删除规则
- ✅ Excel模板下载
- ✅ Excel批量导入
- ✅ Excel导出
- ✅ 数据验证

#### 3.1.5 数据验证规则
- 城市名称不能为空
- 产假类型必须为有效枚举值
- 流产假必须填写流产类型
- 产假天数必须为正整数
- 是否顺延必须为布尔值

### 3.2 津贴规则管理

#### 3.2.1 数据结构
```javascript
{
  id: 1,                                    // 自增ID
  city: "上海",                             // 城市名称（唯一）
  socialAverageWage: 13000.00,             // 社平工资
  companyAverageWage: 18800.00,            // 公司平均工资
  companyContributionWage: 17500.00,       // 公司平均缴费工资（可选）
  calculationBase: "平均工资",              // 津贴计算基数类型
  accountType: "个人",                      // 账户类型
  maternityPolicy: "上海市女职工劳动保护实施办法", // 产假政策说明
  allowancePolicy: "按上海市规定发放",      // 津贴政策说明
  effectiveFrom: "2025-01-01",             // 生效日期
  effectiveTo: null,                       // 失效日期
  createdAt: "2025-01-01T00:00:00Z",      // 创建时间
  updatedAt: "2025-01-01T00:00:00Z"       // 更新时间
}
```

#### 3.2.2 字段说明
- **社平工资**：社会平均工资，用于计算社保3倍上限
- **公司平均工资**：单位上年度月平均工资
- **公司平均缴费工资**：单位上年度月平均缴费工资（部分城市使用）
- **津贴计算基数**：
  - "平均工资"：使用公司平均工资
  - "平均缴费工资"：使用公司平均缴费工资
- **账户类型**：
  - "企业"：津贴发放到企业账户
  - "个人"：津贴发放到个人账户

#### 3.2.3 功能列表
- ✅ 查看津贴规则列表
- ✅ 按城市筛选
- ✅ 添加新规则
- ✅ 编辑规则（行内编辑）
- ✅ 删除规则
- ✅ Excel模板下载
- ✅ Excel批量导入
- ✅ Excel导出
- ✅ 数据验证

#### 3.2.4 数据验证规则
- 城市名称不能为空且唯一
- 社平工资必须为正数
- 公司平均工资必须为正数
- 津贴计算基数必须为"平均工资"或"平均缴费工资"
- 账户类型必须为"企业"或"个人"

### 3.3 员工信息管理

#### 3.3.1 数据结构
```javascript
{
  id: 1,                                    // 自增ID
  employeeId: "EMP001",                    // 员工工号（唯一）
  employeeName: "张三",                     // 员工姓名
  city: "上海",                             // 所在城市
  basicSalary: 15000.00,                   // 基本工资
  socialSecurityBase: 15000.00,            // 社保基数
  department: "人事部",                     // 部门
  position: "人事专员",                     // 职位
  isDifficultBirth: false,                 // 是否难产
  numberOfBabies: 1,                       // 胎数
  pregnancyPeriod: "7个月以上",             // 怀孕时间段
  createdAt: "2025-01-01T00:00:00Z",      // 创建时间
  updatedAt: "2025-01-01T00:00:00Z"       // 更新时间
}
```

#### 3.3.2 功能列表
- ✅ 查看员工列表
- ✅ 按城市筛选
- ✅ 按工号或姓名搜索
- ✅ 添加新员工
- ✅ 编辑员工信息（行内编辑）
- ✅ 删除员工
- ✅ Excel模板下载
- ✅ Excel批量导入
- ✅ Excel导出
- ✅ 数据验证

#### 3.3.3 数据验证规则
- 员工工号不能为空且唯一
- 员工姓名不能为空
- 基本工资必须为正数
- 社保基数必须为正数
- 城市不能为空

### 3.4 节假日管理

#### 3.4.1 数据结构
```javascript
{
  id: 1,                                    // 自增ID
  year: 2025,                              // 年份
  holidayDate: "2025-01-01",               // 日期
  holidayName: "元旦",                      // 节日名称
  isLegalHoliday: true,                    // 是否法定假日
  isMakeupWorkday: false,                  // 是否调休上班日
  createdAt: "2025-01-01T00:00:00Z",      // 创建时间
  updatedAt: "2025-01-01T00:00:00Z"       // 更新时间
}
```

#### 3.4.2 节假日类型
- **法定假日**：`isLegalHoliday=true, isMakeupWorkday=false`
  - 用于产假顺延计算
  - 不计入工作日
- **调休上班日**：`isLegalHoliday=false, isMakeupWorkday=true`
  - 周末但需要上班
  - 计入工作日

#### 3.4.3 功能列表
- ✅ 查看节假日列表
- ✅ 按年份筛选（支持"全部年份"）
- ✅ 上一年/下一年导航
- ✅ 添加节假日
- ✅ 编辑节假日（行内编辑）
- ✅ 删除节假日
- ✅ 复制到下一年
- ✅ Excel模板下载
- ✅ Excel批量导入
- ✅ Excel导出
- ✅ 统计信息展示

#### 3.4.4 数据验证规则
- 日期不能为空且格式正确（YYYY-MM-DD）
- 年份与日期必须一致
- 同一年份的同一日期不能重复
- 类型必须为"节假日"或"工作日"

---

## 4. 智能助手模块（Mock）

### 4.1 功能描述
模拟大模型对话界面，支持语音输入和文件上传，解析用户输入的员工信息并生成计算结果。

### 4.2 功能特性
- ✅ 文本输入对话
- ✅ 语音输入（Web Speech API）
- ✅ 文件上传展示
- ✅ 自动解析姓名、日期、难产类型
- ✅ 生成固定示例结果
- ✅ 示例快捷按钮
- ✅ 清空对话

### 4.3 输入解析规则
- **姓名**：匹配2-4个中文字符
- **日期**：匹配格式 YYYY-MM-DD 或 YYYY年MM月DD日
- **难产类型**：
  - 普通：默认
  - 难产：匹配"难产"关键词
  - 多胞胎：匹配"多胞"、"双胎"、"三胎"关键词

### 4.4 输出示例
```javascript
{
  员工姓名: "张三",
  城市: "上海",
  政府发放津贴金额: 52666.67,
  产前12个月月均工资: 20000,
  单位申报上年度月平均工资: 50000,
  享受产假天数: 158,
  生育津贴: 52666.67,
  需补差金额: 0
}
```

---

## 5. 技术规格

### 5.1 前端技术栈
- **框架**：React 18.2.0
- **日期处理**：date-fns 2.29.3
- **Excel处理**：xlsx 0.18.5
- **文件下载**：file-saver 2.0.5
- **PDF导出**：html2pdf.js 0.12.1
- **样式**：CSS3 + 响应式设计

### 5.2 数据持久化
- **本地存储**：IndexedDB
- **数据表**：
  - `maternityRules`：产假规则
  - `allowanceRules`：津贴规则
  - `employeeData`：员工信息
  - `holidays`：节假日数据（按年份存储）

### 5.3 项目结构
```
src/
├── components/                    # React组件
│   ├── AllowanceCalculator.js    # 产假津贴计算
│   ├── BatchProcessor.js         # 批量处理
│   ├── CityDataManager.js        # 基础数据管理（容器）
│   ├── MaternityRulesManager.js  # 产假规则管理
│   ├── AllowanceRulesManager.js  # 津贴规则管理
│   ├── EmployeeInfoManager.js    # 员工信息管理
│   ├── HolidayManager.js         # 节假日管理
│   ├── LeaveCalendar.js          # 产假日历可视化
│   ├── AIChatDemo.js             # 智能助手Mock
│   └── CityDataManager.css       # 共享样式
├── api/                          # Mock API层
│   ├── maternityApi.js           # 产假计算API
│   └── dataManagementApi.js      # 数据管理API
├── utils/                        # 工具函数
│   ├── maternityCalculations.js # 产假计算逻辑
│   ├── batchCalculations.js     # 批量计算
│   ├── cityDataUtils.js         # 城市数据管理
│   ├── excelUtils.js            # Excel处理
│   ├── holidayUtils.js          # 节假日工具
│   └── indexedDb.js             # IndexedDB封装
├── App.js                        # 主应用
├── index.js                      # 入口文件
└── index.css                     # 全局样式
```

### 5.4 核心工具函数

#### 5.4.1 产假计算
```javascript
// 自动计算产假天数
autoCalculateMaternityDays(
  city,                          // 城市
  isDifficultBirth,              // 是否难产
  numberOfBabies,                // 胎数
  pregnancyPeriod,               // 怀孕时间段
  isMiscarriage,                 // 是否流产
  doctorAdviceDays,              // 医嘱天数
  meetsSupplementalDifficultBirth, // 是否补充难产
  isSecondThirdChild             // 是否二孩三孩
)

// 产假津贴计算
calculateMaternityAllowance(
  city,                          // 城市
  employeeBasicSalary,           // 员工基本工资
  startDate,                     // 开始日期
  isDifficultBirth,              // 是否难产
  numberOfBabies,                // 胎数
  pregnancyPeriod,               // 怀孕时间段
  paymentMethod,                 // 津贴发放方式
  overrideEndDate,               // 覆盖结束日期
  isMiscarriage,                 // 是否流产
  doctorAdviceDays,              // 医嘱天数
  meetsSupplementalDifficultBirth, // 是否补充难产
  overrideGovernmentPaidAmount,  // 覆盖政府发放金额
  overridePersonalSSMonthly,     // 覆盖个人社保月缴
  overrideCompanyAvg,            // 覆盖公司平均工资
  overrideSocialLimit,           // 覆盖社保上限
  employeeBaseSalaryCurrent,     // 员工当前基本工资
  salaryAdjustment,              // 工资调整
  socialSecurityAdjustment,      // 社保调整
  isSecondThirdChild             // 是否二孩三孩
)
```

#### 5.4.2 节假日工具
```javascript
// 获取节假日集合
getHolidaySets(year)

// 计算工作日天数
countWorkingDays(start, end, holidays, makeupWorkdays)

// 保存节假日计划
setHolidayPlan(year, data)

// 获取节假日计划
getHolidayPlan(year)
```

#### 5.4.3 批量处理
```javascript
// 批量处理员工数据
processBatchData(employees)

// 导出结果到Excel
exportResults(results, errors, type)
```

### 5.5 数据验证
- 所有输入参数进行类型和范围验证
- Excel导入数据进行格式和必填项验证
- 计算前验证城市规则是否存在
- 日期格式自动规范化（支持多种格式）

---

## 6. 用户界面规范

### 6.1 主界面布局
- **顶部导航**：Tab切换（产假津贴计算、批量处理、智能助手、基础数据管理）
- **内容区域**：当前Tab对应的功能组件
- **响应式设计**：支持桌面端和移动端

### 6.2 表单设计规范
- **必填字段**：标记 * 号
- **字段分组**：使用卡片或分隔线分组
- **输入验证**：实时验证并显示错误提示
- **自动填充**：选择员工后自动填充相关信息
- **智能联动**：城市选择后自动加载规则

### 6.3 结果展示规范
- **分组展示**：基本信息、产假周期、津贴计算、个人社保等分组
- **计算过程**：显示详细的计算公式和过程
- **可视化**：产假日历可视化展示
- **导出功能**：支持PDF和Excel导出

### 6.4 操作反馈
- **加载状态**：显示加载动画
- **成功提示**：操作成功后显示绿色提示
- **错误提示**：操作失败后显示红色提示并说明原因
- **确认对话框**：删除等危险操作需要确认

---

## 7. 数据示例

### 7.1 产假规则示例
```json
[
  {
    "city": "上海",
    "leaveType": "法定产假",
    "miscarriageType": "",
    "days": 98,
    "isExtendable": false
  },
  {
    "city": "上海",
    "leaveType": "难产假",
    "miscarriageType": "",
    "days": 15,
    "isExtendable": false
  },
  {
    "city": "上海",
    "leaveType": "多胞胎",
    "miscarriageType": "",
    "days": 15,
    "isExtendable": false
  },
  {
    "city": "上海",
    "leaveType": "晚育假/生育假/奖励假",
    "miscarriageType": "",
    "days": 60,
    "isExtendable": true
  },
  {
    "city": "上海",
    "leaveType": "流产假",
    "miscarriageType": "4个月以下",
    "days": 15,
    "isExtendable": false
  },
  {
    "city": "上海",
    "leaveType": "流产假",
    "miscarriageType": "4个月以上",
    "days": 42,
    "isExtendable": false
  }
]
```

### 7.2 津贴规则示例
```json
{
  "city": "上海",
  "socialAverageWage": 13000.00,
  "companyAverageWage": 18800.00,
  "companyContributionWage": null,
  "calculationBase": "平均工资",
  "accountType": "个人",
  "maternityPolicy": "上海市女职工劳动保护实施办法（2022修订）",
  "allowancePolicy": "按上海市上一年度职工月平均工资发放生育津贴",
  "effectiveFrom": "2025-01-01",
  "effectiveTo": null
}
```

### 7.3 员工信息示例
```json
{
  "employeeId": "EMP001",
  "employeeName": "张三",
  "city": "上海",
  "basicSalary": 15000.00,
  "socialSecurityBase": 15000.00,
  "department": "人事部",
  "position": "人事专员",
  "isDifficultBirth": false,
  "numberOfBabies": 1,
  "pregnancyPeriod": "7个月以上"
}
```

### 7.4 节假日示例
```json
[
  {
    "year": 2025,
    "holidayDate": "2025-01-01",
    "holidayName": "元旦",
    "isLegalHoliday": true,
    "isMakeupWorkday": false
  },
  {
    "year": 2025,
    "holidayDate": "2025-02-10",
    "holidayName": "春节",
    "isLegalHoliday": true,
    "isMakeupWorkday": false
  },
  {
    "year": 2025,
    "holidayDate": "2025-02-08",
    "holidayName": "春节调休",
    "isLegalHoliday": false,
    "isMakeupWorkday": true
  }
]
```

---

## 8. 扩展性设计

### 8.1 新增城市
1. 在产假规则表中添加该城市的各类产假规则
2. 在津贴规则表中添加该城市的津贴规则
3. 系统自动识别新城市并在下拉框中显示

### 8.2 新增产假类型
1. 在`cityDataUtils.js`的`MATERNITY_LEAVE_TYPES`枚举中添加新类型
2. 在产假规则表中添加对应规则
3. 在`autoCalculateMaternityDays`函数中添加计算逻辑

### 8.3 新增计算规则
1. 在`calculateMaternityAllowance`函数中添加特殊城市的计算逻辑
2. 使用`if (city === '城市名')`进行条件判断
3. 保持向后兼容性

### 8.4 接入真实后端
1. 替换Mock API实现为真实HTTP请求
2. 前端组件无需修改
3. 保持请求-响应格式一致

---

## 9. 测试用例

### 9.1 产假计算测试
- ✅ 普通产假（法定98天）
- ✅ 难产产假（法定98天 + 难产15天）
- ✅ 多胞胎产假（法定98天 + 多胞胎30天）
- ✅ 完整产假（法定98天 + 奖励60天）
- ✅ 流产假（4个月以下15天）
- ✅ 流产假（4个月以上42天）
- ✅ 医嘱流产假（覆盖规则天数）
- ✅ 广州双重难产假
- ✅ 绍兴二孩三孩奖励假
- ✅ 上海奖励假顺延（遇法定假日）

### 9.2 津贴计算测试
- ✅ 企业账户津贴计算
- ✅ 个人账户津贴计算
- ✅ 需要补差的情况
- ✅ 不需要补差的情况
- ✅ 个人社保缴费计算
- ✅ 首月工资计算
- ✅ 末月工资计算
- ✅ 工资调整计算
- ✅ 社保调整计算
- ✅ 成都特殊公式
- ✅ 天津特殊公式

### 9.3 批量处理测试
- ✅ Excel模板下载
- ✅ Excel文件上传
- ✅ 数据预览
- ✅ 批量计算
- ✅ 错误处理
- ✅ 结果导出

### 9.4 数据管理测试
- ✅ 产假规则CRUD
- ✅ 津贴规则CRUD
- ✅ 员工信息CRUD
- ✅ 节假日CRUD
- ✅ Excel导入导出
- ✅ 数据验证
- ✅ 城市筛选

---

## 10. 附录

### 10.1 常见问题

**Q1: 产假天数计算不准确？**
A: 检查产假规则表中是否有该城市的完整规则，特别是流产假的流产类型是否匹配。

**Q2: 津贴补差金额为负数？**
A: 这是正常情况，表示政府发放的津贴高于员工应领取金额，企业无需补差。系统会自动将补差金额设为0。

**Q3: 个人社保缴费为0？**
A: 检查是否有整月产假。个人社保仅按整月计算，如果首月和末月都有出勤，则可能没有整月产假。

**Q4: 节假日顺延不生效？**
A: 检查产假规则表中对应规则的`isExtendable`字段是否为true，以及节假日表中是否有对应年份的法定假日数据。

**Q5: 批量处理失败？**
A: 检查Excel文件格式是否正确，必填字段是否完整，日期格式是否为YYYY-MM-DD。

### 10.2 术语表
- **产假天数**：员工享受产假的总天数（日历日）
- **工作日**：周一至周五，排除法定节假日，包含调休上班日
- **津贴计算基数**：用于计算生育津贴的工资基数
- **社保3倍上限**：社会平均工资的3倍，津贴计算基数的上限
- **公司补差**：公司需要补给员工的差额
- **个人社保缴费**：员工需要自行缴纳的社保个人部分
- **整月产假**：完全覆盖整个自然月的产假，用于计算个人社保
- **法定假日**：国家规定的节假日，不计入工作日
- **调休上班日**：周末但需要上班的日期，计入工作日

### 10.3 更新日志

**v1.1 (2025-10-07)**
- ✅ 新增绍兴二孩三孩特殊规则
- ✅ 完善法定节假日顺延计算逻辑
- ✅ 优化产假日历可视化
- ✅ 新增工资调整和社保调整功能
- ✅ 优化批量处理性能
- ✅ 完善数据验证机制
- ✅ 新增智能助手Mock功能
- ✅ 重构基础数据管理模块（模块化）

**v1.0 (2025-01-01)**
- ✅ 初始版本发布
- ✅ 产假计算功能
- ✅ 津贴计算功能
- ✅ 批量处理功能
- ✅ 基础数据管理功能

---

## 结语

本需求文档详细描述了产假计算系统的所有功能模块、计算规则、数据结构和技术规格。开发团队可以根据本文档进行系统开发或重构，确保实现完整、准确的产假计算和津贴管理功能。

如有疑问或需要补充，请参考源代码或联系项目负责人。

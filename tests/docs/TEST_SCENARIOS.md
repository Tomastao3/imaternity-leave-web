# 测试场景详细说明

> 本文档详细说明每个测试文件的测试场景、业务含义和数据准备方法。

## 📑 目录

- [01 - 登录功能测试](#01---登录功能测试)
- [02 - 产假津贴计算器测试](#02---产假津贴计算器测试)
- [03 - 批量处理测试](#03---批量处理测试)
- [04 - 基础数据管理测试](#04---基础数据管理测试)
- [05 - AI助手测试](#05---ai助手测试)
- [测试数据说明](#测试数据说明)
- [如何添加新测试](#如何添加新测试)

---

## 01 - 登录功能测试

**文件位置：** `tests/e2e/01-login.spec.js`

### 业务背景

产假计算系统支持两种角色登录：
- **员工角色**：只能查看产假津贴计算和AI助手
- **HR角色**：可以访问所有功能，包括批量处理和数据管理

### 测试场景

#### 1. 显示登录页面基本元素
**目的：** 验证登录页面正确渲染

**步骤：**
1. 访问首页
2. 验证用户名输入框可见
3. 验证密码输入框可见
4. 验证员工登录按钮可见
5. 验证HR登录按钮可见

#### 2. HR登录成功
**目的：** 验证HR可以正常登录并访问所有功能

**步骤：**
1. 输入HR用户名
2. 点击"HR登录"按钮
3. 验证登录成功（主页面出现）
4. 验证会话信息正确（username、role）
5. 验证所有标签可见（产假津贴计算、批量处理、基础数据管理、智能助手）

**测试数据：** `tests/fixtures/e2e/employees.json` 中的 `hrUser`

#### 3. 员工登录成功（受限权限）
**目的：** 验证员工登录后只能访问受限功能

**步骤：**
1. 输入员工用户名
2. 点击"员工登录"按钮
3. 验证登录成功或失败（取决于员工是否存在）
4. 如果成功，验证只能看到"产假津贴计算"和"智能助手"标签
5. 验证"批量处理"和"基础数据管理"标签不可见

**注意：** 测试员工可能不存在于实际系统中，测试会处理这种情况。

#### 4. 员工登录失败 - 员工信息不存在
**目的：** 验证系统正确处理不存在的员工

**步骤：**
1. 输入不存在的员工用户名
2. 点击"员工登录"按钮
3. 验证显示错误消息（"员工信息不存在"）
4. 验证未登录（仍在登录页面）

#### 5. 空用户名验证
**目的：** 验证必填字段校验

**步骤：**
1. 不输入用户名
2. 直接点击登录按钮
3. 验证显示错误提示（"请输入用户名"）

#### 6. 会话持久化
**目的：** 验证刷新页面后会话保持

**步骤：**
1. HR登录成功
2. 获取会话信息
3. 刷新页面
4. 验证会话仍然存在
5. 验证仍在主页面（未返回登录页）

#### 7. 登出功能
**目的：** 验证登出清除会话

**步骤：**
1. 登录成功
2. 点击登出按钮
3. 验证返回登录页面
4. 验证会话已清除

---

## 02 - 产假津贴计算器测试

**文件位置：** `tests/e2e/02-allowance-calculator.spec.js`

### 业务背景

产假津贴计算器是系统的核心功能，根据城市规则、员工工资、产假天数等信息，计算：
- 政府发放的产假津贴
- 员工应领取的金额
- 公司需要补差的金额

不同城市有不同的计算公式，需要分别测试。

### 测试场景分组

#### 基础功能测试

##### 1. 基础计算流程
**目的：** 验证完整的计算流程

**步骤：**
1. HR登录
2. 切换到"产假津贴计算"标签
3. 选择城市（上海）
4. 填写公司平均工资、员工工资、社保上限
5. 填写产假开始日期
6. 点击"计算津贴补差"
7. 验证结果区域显示
8. 验证产假天数大于0

**测试数据：** `tests/fixtures/e2e/cityRules.json` 中的 `shanghai.testCase`

##### 2. 输入验证
**目的：** 验证必填字段校验

**步骤：**
1. 只选择城市，不填写其他字段
2. 点击计算
3. 验证有错误提示或结果未显示

##### 3. 重置功能
**目的：** 验证重置清空所有输入

**步骤：**
1. 填写完整表单
2. 点击重置按钮
3. 验证所有输入框已清空

##### 4. 扣减项管理
**目的：** 验证添加和管理扣减项

**步骤：**
1. 填写基本信息
2. 添加扣减项（个税 1000元）
3. 添加第二个扣减项（社保补扣 500元）
4. 点击计算
5. 验证结果显示

#### 多城市规则测试

##### 5. 上海 - 标准计算公式
**业务规则：** 使用标准的月平均工资计算方式

**测试数据：** `cityRules.shanghai`

**验证点：**
- 产假天数：158天
- 计算结果正确显示

##### 6. 深圳 - 标准计算公式
**业务规则：** 使用标准计算公式，产假天数178天

**测试数据：** `cityRules.shenzhen`

**验证点：**
- 产假天数：178天
- 计算结果正确显示

##### 7. 成都 - 特殊公式 (* 12 / 365)
**业务规则：** 成都使用特殊的日均工资计算公式

**测试数据：** `cityRules.chengdu`

**验证点：**
- 计算过程包含 `* 12 / 365` 公式
- 难产假计算正确

##### 8. 天津 - 特殊公式 (/ 30.4)
**业务规则：** 天津使用 30.4 作为除数

**测试数据：** `cityRules.tianjin`

**验证点：**
- 计算过程包含 `/ 30.4 *` 公式
- 个人账户模式计算正确

#### 高级功能测试

##### 9. 导出PDF
**目的：** 验证PDF导出功能

**步骤：**
1. 完成计算
2. 点击"导出PDF"按钮
3. 验证文件下载
4. 验证文件名包含 `.pdf`

##### 10. 导出Excel
**目的：** 验证Excel导出功能

**步骤：**
1. 完成计算
2. 点击"导出Excel"按钮
3. 验证文件下载
4. 验证文件名包含 `.xlsx`

##### 11. 休假日历切换
**目的：** 验证日历显示功能

**步骤：**
1. 完成计算
2. 点击"展示休假日历"按钮
3. 验证日历组件显示/隐藏

#### 权限测试

##### 12. 员工角色权限
**目的：** 验证员工只能看到受限标签

**验证点：**
- 可见：产假津贴计算、智能助手
- 不可见：批量处理、基础数据管理

##### 13. HR角色权限
**目的：** 验证HR可以看到所有标签

**验证点：**
- 所有标签都可见

---

## 03 - 批量处理测试

**文件位置：** `tests/e2e/03-batch-processor.spec.js`

### 业务背景

批量处理功能允许HR通过Excel文件批量导入员工信息，系统自动计算每个员工的产假天数和津贴补差。

### 测试场景

#### 1. 下载Excel模板
**目的：** 验证模板下载功能

**步骤：**
1. HR登录
2. 切换到"批量处理"标签
3. 点击"下载Excel模板"
4. 验证文件下载
5. 验证文件名包含"模板"或"template"

#### 2. 上传有效Excel文件并预览
**目的：** 验证文件上传和预览功能

**步骤：**
1. 上传测试Excel文件
2. 等待文件处理
3. 验证预览区域显示
4. 验证预览数据不为空

**测试文件：** `tests/fixtures/e2e/batchSample.xlsx`

#### 3. 批量处理 - 处理有效数据
**目的：** 验证批量计算功能

**步骤：**
1. 上传测试Excel
2. 点击"开始批量处理"
3. 等待处理完成
4. 验证结果区域显示
5. 验证有成功处理的数据

#### 4. 批量处理 - 错误数据验证
**目的：** 验证错误数据处理

**步骤：**
1. 上传包含错误数据的Excel
2. 开始批量处理
3. 验证有失败的数据
4. 验证显示错误消息

**测试数据：** Excel中包含缺失字段和无效城市的数据

#### 5. 导出处理结果
**目的：** 验证结果导出功能

**步骤：**
1. 完成批量处理
2. 点击"导出结果"
3. 验证文件下载
4. 验证文件名包含"结果"或"result"

#### 6. 文件格式验证
**目的：** 验证只接受Excel文件

**步骤：**
1. 尝试上传非Excel文件（如JSON）
2. 验证显示错误提示

#### 7. 未选择文件直接处理
**目的：** 验证必须先上传文件

**步骤：**
1. 不上传文件
2. 直接点击"开始批量处理"
3. 验证显示错误提示

### 测试数据说明

**batchSample.xlsx 包含：**
- 3条正常数据（上海、深圳、成都各1条）
- 2条错误数据（缺失字段、无效城市）

---

## 04 - 基础数据管理测试

**文件位置：** `tests/e2e/04-city-data-manager.spec.js`

### 业务背景

基础数据管理是HR专属功能，用于管理：
- 产假规则（各城市的产假天数规则）
- 津贴规则（社平工资、账户类型等）
- 返还规则
- 员工信息
- 节假日

### 测试场景

#### 产假规则管理

##### 1. 查看产假规则列表
**步骤：**
1. HR登录
2. 切换到"基础数据管理"
3. 切换到"产假规则"子标签
4. 验证表格显示

##### 2. 选择城市筛选规则
**步骤：**
1. 选择"上海"
2. 验证只显示上海的规则

##### 3. 添加新规则（测试后回滚）
**步骤：**
1. 点击"添加"按钮
2. 填写测试规则（使用TEST_前缀）
3. 保存
4. 验证行数增加
5. **回滚：删除测试数据**

**重要：** 测试数据使用 `TEST_CITY_临时测试` 前缀，测试后必须删除

#### 津贴规则管理

##### 4. 查看津贴规则列表
##### 5. 切换标签功能

#### 员工信息管理（HR专属）

##### 6. HR可以访问员工信息标签
**验证点：** 员工信息标签对HR可见

#### 节假日管理

##### 7. 查看节假日列表

#### 导入导出功能

##### 8. 导出Excel功能
##### 9. 保存全部数据功能

#### 权限测试

##### 10. 员工角色不应该看到基础数据管理标签

---

## 05 - AI助手测试

**文件位置：** `tests/e2e/05-ai-chat.spec.js`

### 业务背景

AI助手提供智能问答功能，帮助用户了解产假计算相关政策和使用方法。

**AI服务地址：** `http://127.0.0.1:8000/rag/ask`

**Mock模式：** 如果AI服务不可用，测试会自动使用Mock模式。

### 测试场景

#### 1. 发送消息并接收回复
**目的：** 验证基本的问答功能

**步骤：**
1. HR登录
2. 切换到"智能助手"标签
3. 发送消息："产假计算系统有哪些功能？"
4. 等待AI回复
5. 验证收到回复

**Mock处理：** 如果AI服务不可用，返回模拟回复

#### 2. 多轮对话
**目的：** 验证连续对话功能

**步骤：**
1. 发送第一条消息："你好"
2. 等待回复
3. 发送第二条消息："产假天数怎么计算？"
4. 等待回复
5. 验证消息历史包含多轮对话

#### 3. 空输入验证
**目的：** 验证不能发送空消息

**步骤：**
1. 不输入任何内容
2. 点击发送
3. 验证消息未发送

#### 4. 消息历史显示
**目的：** 验证消息正确显示

**步骤：**
1. 发送消息
2. 验证用户消息显示在界面上

#### 5. 错误处理 - AI服务不可用
**目的：** 验证错误处理

**步骤：**
1. Mock AI服务返回500错误
2. 发送消息
3. 验证显示错误消息

#### 权限测试

##### 6. 员工角色可以访问AI助手
**验证点：** AI助手标签对员工可见

---

## 测试数据说明

### 测试数据位置

```
tests/fixtures/e2e/
├── employees.json      # 员工测试数据
├── cityRules.json      # 城市规则测试数据
└── batchSample.xlsx    # 批量处理测试Excel
```

### 测试数据特点

1. **所有测试数据都有明确的前缀**
   - 员工ID：`TEST_EMP_`、`TEST_BATCH_`
   - 城市名：`TEST_CITY_`
   - 目的：与真实数据区分，便于清理

2. **测试数据不会污染实际系统**
   - 测试后自动回滚
   - 使用独立的测试标识

3. **包含正常和异常数据**
   - 正常数据：验证功能正常工作
   - 异常数据：验证错误处理

### employees.json 结构

```json
{
  "validEmployee": {
    "employeeName": "测试员工张三",
    "employeeId": "TEST_EMP_001",
    "basicSalary": 15000,
    "city": "上海"
  },
  "invalidEmployee": {
    "employeeName": "不存在的测试员工",
    "employeeId": "INVALID_TEST_EMP"
  },
  "hrUser": {
    "username": "测试HR管理员",
    "role": "hr"
  }
}
```

### cityRules.json 结构

```json
{
  "shanghai": {
    "city": "上海",
    "testCase": { /* 测试输入数据 */ },
    "expectedResults": { /* 期望结果 */ }
  }
}
```

---

## 如何添加新测试

### 步骤1：确定测试场景

明确要测试的功能和业务场景。

### 步骤2：准备测试数据

在 `tests/fixtures/e2e/` 中添加测试数据。

### 步骤3：创建或更新测试文件

```javascript
test('新测试场景描述', async ({ page }) => {
  // 1. 准备：登录、导航等
  const loginPage = new LoginPage(page);
  await loginPage.loginAsHR('测试用户');
  
  // 2. 执行：操作页面
  const calculatorPage = new AllowanceCalculatorPage(page);
  await calculatorPage.fillBasicInfo(testData);
  await calculatorPage.calculate();
  
  // 3. 验证：断言结果
  const result = await calculatorPage.getCalculationResult();
  expect(result.hasResult).toBe(true);
});
```

### 步骤4：运行测试

```bash
npx playwright test tests/e2e/新测试文件.spec.js
```

### 步骤5：更新文档

在本文档中添加新测试场景的说明。

---

## 测试维护建议

### 定期检查

1. **每周运行一次完整测试套件**
2. **新功能上线前运行相关测试**
3. **修复失败的测试，不要忽略**

### 数据清理

1. **测试后删除测试数据**
2. **定期检查是否有残留的测试数据**
3. **使用明确的测试数据前缀**

### 文档更新

1. **新增测试时更新本文档**
2. **修改测试场景时更新说明**
3. **记录已知问题和解决方案**

---

## 相关文档

- [Playwright快速上手指南](./PLAYWRIGHT_GUIDE.md)
- [测试计划](../TEST_PLAN.md)
- [实施指南](../IMPLEMENTATION_GUIDE.md)

---

**最后更新：** 2025-10-22

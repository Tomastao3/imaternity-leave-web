# E2E 测试待办事项

## 概述

本文档记录了E2E测试套件中当前被跳过（skip）的测试用例，这些测试用例本应通过但由于实现复杂性或技术限制暂时跳过。

**最后更新**: 2025-10-22

---

## 🔴 高优先级待修复测试

### 1. 产假津贴计算器 - 重置功能 (02-allowance-calculator.spec.js)

**测试名称**: `重置功能 - 应该清空所有输入`

**当前状态**: ⏭️ Skipped

**问题描述**:
- 点击重置按钮后，表单字段没有完全清空
- 测试期望所有字段为空，但实际上部分字段仍保留值
- 根据文档，重置功能的设计是保留城市选择，避免闪烁

**修复建议**:
1. **选项A**: 调整测试预期 - 验证重置后城市保留，其他字段清空
2. **选项B**: 查看应用实现，确认重置按钮的确切行为规范
3. **选项C**: 添加更精确的断言，只验证应该清空的字段

**相关文件**:
- `tests/e2e/02-allowance-calculator.spec.js` (第112行)
- `mdBackup/RESET_OPTIMIZATION.md` (重置功能设计文档)
- `components/AllowanceCalculator.js` (reset函数)

**估计工时**: 2小时

---

### 2. 产假津贴计算器 - 扣减项管理 (02-allowance-calculator.spec.js)

**测试名称**: `扣减项管理 - 添加和删除扣减项`

**当前状态**: ⏭️ Skipped

**问题描述**:
- 无法找到扣减项输入框
- 选择器 `input[placeholder*="扣减说明"]` 超时
- 扣减项功能可能需要特定条件才显示（如选择"个人账户"发放方式）

**修复建议**:
1. 调查扣减项区域的显示条件
2. 在测试中先选择正确的发放方式（个人账户）
3. 等待扣减项区域完全加载
4. 更新Page Object的选择器以匹配实际DOM结构

**相关文件**:
- `tests/e2e/02-allowance-calculator.spec.js` (第141行)
- `tests/pages/AllowanceCalculatorPage.js` (addDeduction方法)
- `components/AllowanceCalculator.js` (扣减项卡片代码)

**估计工时**: 3小时

---

## 🟡 中优先级待修复测试

### 3. 基础数据管理 - 添加新规则 (04-city-data-manager.spec.js)

**测试名称**: `添加新规则（测试后回滚）`

**当前状态**: ⏭️ Skipped

**问题描述**:
- 填写表单时，城市选择器找不到选项
- 选择器 `getByLabel(/城市/i).first()` 元素不可见
- 涉及复杂的动态表单填写和数据回滚

**修复建议**:
1. 分析添加规则表单的实际DOM结构
2. 使用正确的选择器定位表单元素
3. 实现表单填写辅助方法
4. 添加数据回滚机制（或在afterEach中清理）

**相关文件**:
- `tests/e2e/04-city-data-manager.spec.js` (第104行)
- `tests/pages/CityDataManagerPage.js` (fillRuleForm方法)

**估计工时**: 4小时

---

### 4. 基础数据管理 - 保存全部数据功能 (04-city-data-manager.spec.js)

**测试名称**: `保存全部数据功能`

**当前状态**: ⏭️ Skipped

**问题描述**:
- 当前被跳过，原因待调查
- 可能涉及数据持久化和验证

**修复建议**:
1. 调查保存功能的实际行为
2. 验证保存后数据是否正确写入IndexedDB
3. 添加适当的等待和验证逻辑

**相关文件**:
- `tests/e2e/04-city-data-manager.spec.js` (第282行)

**估计工时**: 2小时

---

## 🟢 低优先级待修复测试

### 5. 批量处理 - 导出处理结果 (03-batch-processor.spec.js)

**测试名称**: `导出处理结果`

**当前状态**: ⏭️ Skipped

**问题描述**:
- 导出功能测试被跳过
- 可能涉及文件下载验证

**修复建议**:
1. 使用Playwright的download事件监听文件下载
2. 验证下载的文件格式和内容
3. 测试后清理下载的文件

**相关文件**:
- `tests/e2e/03-batch-processor.spec.js` (第126行)
- `tests/pages/BatchProcessorPage.js`

**估计工时**: 2小时

---

### 6. 产假津贴计算器 - 导出功能 (02-allowance-calculator.spec.js)

**测试名称**: 
- `导出功能 - PDF导出`
- `导出功能 - Excel导出`

**当前状态**: ⏭️ Skipped (2个测试)

**问题描述**:
- PDF和Excel导出功能测试被跳过
- 需要验证文件下载和格式

**修复建议**:
1. 实现文件下载验证逻辑
2. 可选：验证导出文件的内容正确性
3. 测试后清理下载的文件

**相关文件**:
- `tests/e2e/02-allowance-calculator.spec.js` (第364-412行)

**估计工时**: 3小时

---

### 7. 产假津贴计算器 - 休假日历 (02-allowance-calculator.spec.js)

**测试名称**: `休假日历 - 切换显示`

**当前状态**: ⏭️ Skipped

**问题描述**:
- 日历功能测试被跳过
- 可能涉及复杂的UI交互

**修复建议**:
1. 验证日历组件的显示/隐藏切换
2. 可选：验证日历中的日期数据正确性

**相关文件**:
- `tests/e2e/02-allowance-calculator.spec.js` (第441行)

**估计工时**: 2小时

---

## ⚠️ 需要特殊处理的测试

### 8. 权限测试 - SecurityError (04-city-data-manager.spec.js & 05-ai-chat.spec.js)

**测试名称**: 
- `员工角色不应该看到基础数据管理标签`
- 所有AI助手权限测试

**当前状态**: ⏭️ Skipped

**问题描述**:
- 访问sessionStorage时出现SecurityError
- 可能与页面上下文或iframe相关

**修复建议**:
1. 调查SecurityError的根本原因
2. 检查是否在正确的页面上下文中执行
3. 可能需要使用不同的方式处理会话清理
4. 考虑使用browser context isolation

**相关文件**:
- `tests/e2e/04-city-data-manager.spec.js` (第309行)
- `tests/e2e/05-ai-chat.spec.js` (整个文件)

**估计工时**: 4小时

---

### 9. AI助手功能测试 (05-ai-chat.spec.js)

**测试名称**: 全部AI助手测试（8个测试）

**当前状态**: ⏭️ Skipped (整个文件)

**问题描述**:
- 依赖外部AI服务（http://127.0.0.1:8000/rag/ask）
- 测试不稳定，异步响应难以预测
- Mock模式测试也失败

**修复建议**:
1. **短期**: 完善Mock机制，确保测试不依赖真实AI服务
2. **中期**: 使用Playwright的网络拦截改进Mock响应
3. **长期**: 考虑使用契约测试或集成测试替代E2E测试
4. 添加更健壮的等待和重试逻辑

**相关文件**:
- `tests/e2e/05-ai-chat.spec.js` (整个文件)
- `tests/pages/AIChatPage.js`

**估计工时**: 8小时

**特殊说明**: AI功能可以考虑用单独的测试套件，不作为主要E2E测试的一部分

---

## 📊 统计汇总

| 优先级 | 测试数量 | 预估总工时 |
|--------|----------|-----------|
| 🔴 高 | 2 | 5小时 |
| 🟡 中 | 2 | 6小时 |
| 🟢 低 | 3 | 7小时 |
| ⚠️ 特殊 | 2组(9个测试) | 12小时 |
| **总计** | **18个测试** | **30小时** |

---

## 🎯 建议的修复顺序

### Phase 1 - 快速胜利 (1周)
1. ✅ 重置功能测试 - 调整预期
2. ✅ 导出功能测试 - PDF/Excel
3. ✅ 休假日历测试

### Phase 2 - 核心功能 (2周)
4. ✅ 扣减项管理测试
5. ✅ 添加新规则测试
6. ✅ 保存全部数据功能

### Phase 3 - 高级功能 (1周)
7. ✅ 批量处理导出测试
8. ✅ 权限测试SecurityError修复

### Phase 4 - AI功能 (选择性)
9. ⚠️ AI助手测试（可作为独立项目）

---

## 📝 测试改进建议

### 1. 代码重用
- 创建更多共享的辅助函数（如setupTestWithData）
- 统一数据加载逻辑
- 标准化等待和验证模式

### 2. 测试数据
- 考虑创建专门的测试数据集
- 确保测试数据的完整性和一致性
- 添加数据验证工具

### 3. 错误处理
- 为常见失败场景添加更好的错误消息
- 实现自动重试机制
- 添加详细的调试日志

### 4. CI/CD集成
- 配置测试并行执行（针对稳定的测试）
- 添加测试报告生成
- 设置测试覆盖率目标

---

## 🔗 相关资源

- [Playwright最佳实践](https://playwright.dev/docs/best-practices)
- [测试套件运行指南](../README.md)
- [Page Object模式文档](./TEST_ARCHITECTURE.md)
- [源代码重置功能说明](../mdBackup/RESET_OPTIMIZATION.md)

---

**注意**: 本文档会随着测试修复进度持续更新。完成测试后，请在对应项目前标记 ✅。
